input {
  jdbc {
    id => "news_article"
    jdbc_connection_string => "jdbc:mysql://${MYSQL_JDBC_HOST:mysql}:${MYSQL_JDBC_PORT:3306}/${MYSQL_JDBC_DATABASE}?${MYSQL_JDBC_PARAMS:allowPublicKeyRetrieval=true&useSSL=false&useUnicode=true&characterEncoding=UTF-8&serverTimezone=UTC}"
    jdbc_user => "${MYSQL_JDBC_USER}"
    jdbc_password => "${MYSQL_JDBC_PASSWORD}"
    jdbc_driver_library => "${LOGSTASH_JDBC_DRIVER_JAR}"
    jdbc_driver_class => "com.mysql.cj.jdbc.Driver"
    schedule => "${MYSQL_JDBC_SCHEDULE:*/1 * * * *}"
    statement_filepath => "/usr/share/logstash/pipeline/sql/news_article.sql"
    use_column_value => true
    tracking_column => "id"
    tracking_column_type => "numeric"
    record_last_run => true
    last_run_metadata_path => "/usr/share/logstash/data/news_article_last_run.yml"
    clean_run => false
    jdbc_default_timezone => "UTC"
    add_field => {
      "[@metadata][target_index]" => "naver-news-articles"
      "[@metadata][dataset]" => "news_article"
    }
  }

  jdbc {
    id => "delivery_log"
    jdbc_connection_string => "jdbc:mysql://${MYSQL_JDBC_HOST:mysql}:${MYSQL_JDBC_PORT:3306}/${MYSQL_JDBC_DATABASE}?${MYSQL_JDBC_PARAMS:allowPublicKeyRetrieval=true&useSSL=false&useUnicode=true&characterEncoding=UTF-8&serverTimezone=UTC}"
    jdbc_user => "${MYSQL_JDBC_USER}"
    jdbc_password => "${MYSQL_JDBC_PASSWORD}"
    jdbc_driver_library => "${LOGSTASH_JDBC_DRIVER_JAR}"
    jdbc_driver_class => "com.mysql.cj.jdbc.Driver"
    schedule => "${MYSQL_JDBC_SCHEDULE:*/1 * * * *}"
    statement_filepath => "/usr/share/logstash/pipeline/sql/delivery_log.sql"
    use_column_value => true
    tracking_column => "id"
    tracking_column_type => "numeric"
    record_last_run => true
    last_run_metadata_path => "/usr/share/logstash/data/delivery_log_last_run.yml"
    clean_run => false
    jdbc_default_timezone => "UTC"
    add_field => {
      "[@metadata][target_index]" => "naver-news-delivery"
      "[@metadata][dataset]" => "delivery_log"
    }
  }

  jdbc {
    id => "keyword_exclusion"
    jdbc_connection_string => "jdbc:mysql://${MYSQL_JDBC_HOST:mysql}:${MYSQL_JDBC_PORT:3306}/${MYSQL_JDBC_DATABASE}?${MYSQL_JDBC_PARAMS:allowPublicKeyRetrieval=true&useSSL=false&useUnicode=true&characterEncoding=UTF-8&serverTimezone=UTC}"
    jdbc_user => "${MYSQL_JDBC_USER}"
    jdbc_password => "${MYSQL_JDBC_PASSWORD}"
    jdbc_driver_library => "${LOGSTASH_JDBC_DRIVER_JAR}"
    jdbc_driver_class => "com.mysql.cj.jdbc.Driver"
    schedule => "${MYSQL_JDBC_SCHEDULE:*/1 * * * *}"
    statement_filepath => "/usr/share/logstash/pipeline/sql/keyword_exclusion.sql"
    use_column_value => true
    tracking_column => "id"
    tracking_column_type => "numeric"
    record_last_run => true
    last_run_metadata_path => "/usr/share/logstash/data/keyword_exclusion_last_run.yml"
    clean_run => false
    jdbc_default_timezone => "UTC"
    add_field => {
      "[@metadata][target_index]" => "naver-news-keyword-exclusion"
      "[@metadata][dataset]" => "keyword_exclusion"
    }
  }

  jdbc {
    id => "news_company"
    jdbc_connection_string => "jdbc:mysql://${MYSQL_JDBC_HOST:mysql}:${MYSQL_JDBC_PORT:3306}/${MYSQL_JDBC_DATABASE}?${MYSQL_JDBC_PARAMS:allowPublicKeyRetrieval=true&useSSL=false&useUnicode=true&characterEncoding=UTF-8&serverTimezone=UTC}"
    jdbc_user => "${MYSQL_JDBC_USER}"
    jdbc_password => "${MYSQL_JDBC_PASSWORD}"
    jdbc_driver_library => "${LOGSTASH_JDBC_DRIVER_JAR}"
    jdbc_driver_class => "com.mysql.cj.jdbc.Driver"
    schedule => "${MYSQL_JDBC_SCHEDULE:*/1 * * * *}"
    statement_filepath => "/usr/share/logstash/pipeline/sql/news_company.sql"
    use_column_value => true
    tracking_column => "id"
    tracking_column_type => "numeric"
    record_last_run => true
    last_run_metadata_path => "/usr/share/logstash/data/news_company_last_run.yml"
    clean_run => false
    jdbc_default_timezone => "UTC"
    add_field => {
      "[@metadata][target_index]" => "naver-news-companies"
      "[@metadata][dataset]" => "news_company"
    }
  }

  jdbc {
    id => "press_exclusion"
    jdbc_connection_string => "jdbc:mysql://${MYSQL_JDBC_HOST:mysql}:${MYSQL_JDBC_PORT:3306}/${MYSQL_JDBC_DATABASE}?${MYSQL_JDBC_PARAMS:allowPublicKeyRetrieval=true&useSSL=false&useUnicode=true&characterEncoding=UTF-8&serverTimezone=UTC}"
    jdbc_user => "${MYSQL_JDBC_USER}"
    jdbc_password => "${MYSQL_JDBC_PASSWORD}"
    jdbc_driver_library => "${LOGSTASH_JDBC_DRIVER_JAR}"
    jdbc_driver_class => "com.mysql.cj.jdbc.Driver"
    schedule => "${MYSQL_JDBC_SCHEDULE:*/1 * * * *}"
    statement_filepath => "/usr/share/logstash/pipeline/sql/press_exclusion.sql"
    use_column_value => true
    tracking_column => "id"
    tracking_column_type => "numeric"
    record_last_run => true
    last_run_metadata_path => "/usr/share/logstash/data/press_exclusion_last_run.yml"
    clean_run => false
    jdbc_default_timezone => "UTC"
    add_field => {
      "[@metadata][target_index]" => "naver-news-press-exclusion"
      "[@metadata][dataset]" => "press_exclusion"
    }
  }

  jdbc {
    id => "runtime_state"
    jdbc_connection_string => "jdbc:mysql://${MYSQL_JDBC_HOST:mysql}:${MYSQL_JDBC_PORT:3306}/${MYSQL_JDBC_DATABASE}?${MYSQL_JDBC_PARAMS:allowPublicKeyRetrieval=true&useSSL=false&useUnicode=true&characterEncoding=UTF-8&serverTimezone=UTC}"
    jdbc_user => "${MYSQL_JDBC_USER}"
    jdbc_password => "${MYSQL_JDBC_PASSWORD}"
    jdbc_driver_library => "${LOGSTASH_JDBC_DRIVER_JAR}"
    jdbc_driver_class => "com.mysql.cj.jdbc.Driver"
    schedule => "${MYSQL_JDBC_SCHEDULE:*/1 * * * *}"
    statement_filepath => "/usr/share/logstash/pipeline/sql/runtime_state.sql"
    use_column_value => true
    tracking_column => "updated_at"
    tracking_column_type => "timestamp"
    record_last_run => true
    last_run_metadata_path => "/usr/share/logstash/data/runtime_state_last_run.yml"
    clean_run => false
    jdbc_default_timezone => "UTC"
    add_field => {
      "[@metadata][target_index]" => "naver-news-runtime-state"
      "[@metadata][dataset]" => "runtime_state"
    }
  }

  jdbc {
    id => "spam_keyword_log"
    jdbc_connection_string => "jdbc:mysql://${MYSQL_JDBC_HOST:mysql}:${MYSQL_JDBC_PORT:3306}/${MYSQL_JDBC_DATABASE}?${MYSQL_JDBC_PARAMS:allowPublicKeyRetrieval=true&useSSL=false&useUnicode=true&characterEncoding=UTF-8&serverTimezone=UTC}"
    jdbc_user => "${MYSQL_JDBC_USER}"
    jdbc_password => "${MYSQL_JDBC_PASSWORD}"
    jdbc_driver_library => "${LOGSTASH_JDBC_DRIVER_JAR}"
    jdbc_driver_class => "com.mysql.cj.jdbc.Driver"
    schedule => "${MYSQL_JDBC_SCHEDULE:*/1 * * * *}"
    statement_filepath => "/usr/share/logstash/pipeline/sql/spam_keyword_log.sql"
    use_column_value => true
    tracking_column => "updated_marker"
    tracking_column_type => "timestamp"
    record_last_run => true
    last_run_metadata_path => "/usr/share/logstash/data/spam_keyword_log_last_run.yml"
    clean_run => false
    jdbc_default_timezone => "UTC"
    add_field => {
      "[@metadata][target_index]" => "naver-news-spam-keywords"
      "[@metadata][dataset]" => "spam_keyword_log"
    }
  }
}

filter {
  mutate {
    remove_field => ["@version"]
  }

  if [@metadata][dataset] == "news_article" {
    mutate {
      convert => {
        "id" => "integer"
        "company_id" => "integer"
      }
      replace => {
        "[@metadata][document_id]" => "%{id}"
      }
    }
    if [published_at] {
      date {
        match => ["published_at", "ISO8601", "yyyy-MM-dd HH:mm:ss", "yyyy-MM-dd HH:mm:ss.SSS"]
        target => "@timestamp"
        timezone => "UTC"
      }
    } else if [fetched_at] {
      date {
        match => ["fetched_at", "ISO8601", "yyyy-MM-dd HH:mm:ss", "yyyy-MM-dd HH:mm:ss.SSS"]
        target => "@timestamp"
        timezone => "UTC"
      }
    }
  } else if [@metadata][dataset] == "delivery_log" {
    mutate {
      convert => {
        "id" => "integer"
        "article_id" => "integer"
        "http_status" => "integer"
      }
      replace => {
        "[@metadata][document_id]" => "%{id}"
      }
    }
    if [sent_at] {
      date {
        match => ["sent_at", "ISO8601", "yyyy-MM-dd HH:mm:ss", "yyyy-MM-dd HH:mm:ss.SSS"]
        target => "@timestamp"
        timezone => "UTC"
      }
    }
  } else if [@metadata][dataset] == "keyword_exclusion" {
    mutate {
      convert => {
        "id" => "integer"
      }
      replace => {
        "[@metadata][document_id]" => "%{id}"
      }
    }
    if [created_at] {
      date {
        match => ["created_at", "ISO8601", "yyyy-MM-dd HH:mm:ss", "yyyy-MM-dd HH:mm:ss.SSS"]
        target => "@timestamp"
        timezone => "UTC"
      }
    }
  } else if [@metadata][dataset] == "news_company" {
    mutate {
      convert => {
        "id" => "integer"
      }
      replace => {
        "[@metadata][document_id]" => "%{id}"
      }
    }
  } else if [@metadata][dataset] == "press_exclusion" {
    mutate {
      convert => {
        "id" => "integer"
      }
      replace => {
        "[@metadata][document_id]" => "%{id}"
      }
    }
    if [created_at] {
      date {
        match => ["created_at", "ISO8601", "yyyy-MM-dd HH:mm:ss", "yyyy-MM-dd HH:mm:ss.SSS"]
        target => "@timestamp"
        timezone => "UTC"
      }
    }
  } else if [@metadata][dataset] == "runtime_state" {
    mutate {
      convert => {
        "id" => "integer"
      }
      replace => {
        "[@metadata][document_id]" => "%{id}"
      }
    }
    if [key] {
      mutate {
        update => {
          "[@metadata][document_id]" => "%{key}"
        }
      }
    }
    if [updated_at] {
      date {
        match => ["updated_at", "ISO8601", "yyyy-MM-dd HH:mm:ss", "yyyy-MM-dd HH:mm:ss.SSS"]
        target => "@timestamp"
        timezone => "UTC"
      }
    }
  } else if [@metadata][dataset] == "spam_keyword_log" {
    mutate {
      convert => {
        "id" => "integer"
        "count" => "integer"
      }
      replace => {
        "[@metadata][document_id]" => "%{id}"
      }
    }
    if [updated_at] {
      date {
        match => ["updated_at", "ISO8601", "yyyy-MM-dd HH:mm:ss", "yyyy-MM-dd HH:mm:ss.SSS"]
        target => "@timestamp"
        timezone => "UTC"
      }
    } else if [created_at] {
      date {
        match => ["created_at", "ISO8601", "yyyy-MM-dd HH:mm:ss", "yyyy-MM-dd HH:mm:ss.SSS"]
        target => "@timestamp"
        timezone => "UTC"
      }
    }
    mutate {
      remove_field => ["updated_marker"]
    }
  }
}

output {
  elasticsearch {
    hosts => ["${ELASTICSEARCH_HOSTS:http://elasticsearch:9200}"]
    index => "%{[@metadata][target_index]}"
    user => "${ELASTICSEARCH_USERNAME:}"
    password => "${ELASTICSEARCH_PASSWORD:}"
    action => "index"
    doc_as_upsert => true
    document_id => "%{[@metadata][document_id]}"
  }
  stdout {
    codec => rubydebug
  }
}
